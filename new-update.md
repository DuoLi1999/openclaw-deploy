│ PRD 需求落地方案：基于 Dify 的交通安全宣传智能化平台升级                                                                                                                                                          │
│                                                                                                                                                                                                                   │
│ Context                                                                                                                                                                                                           │
│                                                                                                                                                                                                                   │
│ PRD 定义了 8 个业务模块（content-producer, media-hub, content-reviewer, plan-manager, analytics, precision-outreach, emergency-response, public-relations），原方案基于 OpenClaw Skills 架构。本方案将其映射到    │
│ Dify Workflow + React 前端 的现有技术栈，保持 Dify 部署模式不变。                                                                                                                                                 │
│                                                                                                                                                                                                                   │
│ traffic-project 已有完整的业务逻辑定义（8 个 SKILL.md）、模拟数据（26 个 JSON）和内容模板（6 个），可直接复用。                                                                                                   │
│                                                                                                                                                                                                                   │
│ 现状 → 目标                                                                                                                                                                                                       │
│ ┌────────────────────┬────────────────────────────────────────────┬─────────────────────────────────────────┐                                                                                                     │
│ │        模块        │                    现状                    │                  目标                   │                                                                                                     │
│ ├────────────────────┼────────────────────────────────────────────┼─────────────────────────────────────────┤                                                                                                     │
│ │ 文案生成           │ ✅ 已有 copywriter workflow + GeneratePage │ 扩展：海报方案 + 视频脚本模式           │                                                                                                     │
│ ├────────────────────┼────────────────────────────────────────────┼─────────────────────────────────────────┤                                                                                                     │
│ │ 素材库             │ mock UI                                    │ 接入真实数据 + Dify 语义搜索            │                                                                                                     │
│ ├────────────────────┼────────────────────────────────────────────┼─────────────────────────────────────────┤                                                                                                     │
│ │ 内容审核           │ 简单敏感词检测                             │ 三级审核（格式→质量→合规）              │                                                                                                     │
│ ├────────────────────┼────────────────────────────────────────────┼─────────────────────────────────────────┤                                                                                                     │
│ │ 宣传计划           │ 已有 planner workflow，无前端              │ 新增 PlanPage                           │                                                                                                     │
│ ├────────────────────┼────────────────────────────────────────────┼─────────────────────────────────────────┤                                                                                                     │
│ │ 效果分析           │ 无                                         │ 新增 analytics workflow + AnalyticsPage │                                                                                                     │
│ ├────────────────────┼────────────────────────────────────────────┼─────────────────────────────────────────┤                                                                                                     │
│ │ 精准宣传/应急/公关 │ 无                                         │ P2 暂不实现，仅设计                     │                                                                                                     │
│ └────────────────────┴────────────────────────────────────────────┴─────────────────────────────────────────┘                                                                                                     │
│ ---                                                                                                                                                                                                               │
│ Phase 0：基础设施 — 多 Workflow 代理                                                                                                                                                                              │
│                                                                                                                                                                                                                   │
│ 问题                                                                                                                                                                                                              │
│                                                                                                                                                                                                                   │
│ 当前 vite.config.ts 只有一条代理路由 + 一个 API Key，无法调用多个 Dify Workflow App。                                                                                                                             │
│                                                                                                                                                                                                                   │
│ 方案                                                                                                                                                                                                              │
│                                                                                                                                                                                                                   │
│ .env 扩展（每个 Workflow 一个 Key）：                                                                                                                                                                             │
│ DIFY_API_KEY=app-xxx           # 文案生成（已有）                                                                                                                                                                 │
│ DIFY_API_KEY_POSTER=app-xxx    # 海报方案                                                                                                                                                                         │
│ DIFY_API_KEY_SCRIPT=app-xxx    # 视频脚本                                                                                                                                                                         │
│ DIFY_API_KEY_REVIEWER=app-xxx  # 三级审核                                                                                                                                                                         │
│ DIFY_API_KEY_MEDIA=app-xxx     # 素材搜索                                                                                                                                                                         │
│ DIFY_API_KEY_PLANNER=app-xxx   # 宣传计划（已有 workflow）                                                                                                                                                        │
│ DIFY_API_KEY_ANALYTICS=app-xxx # 效果分析                                                                                                                                                                         │
│                                                                                                                                                                                                                   │
│ vite.config.ts：为每个 workflow 添加独立代理路由：                                                                                                                                                                │
│ - /api/workflows/* → copywriter（已有）                                                                                                                                                                           │
│ - /api/poster/* → poster-plan-generator                                                                                                                                                                           │
│ - /api/script/* → video-script-generator                                                                                                                                                                          │
│ - /api/reviewer/* → content-reviewer                                                                                                                                                                              │
│ - /api/media/* → material-search                                                                                                                                                                                  │
│ - /api/planner/* → content-strategy-planner                                                                                                                                                                       │
│ - /api/analytics/* → analytics-reporter                                                                                                                                                                           │
│                                                                                                                                                                                                                   │
│ services/dify.ts 泛化：提取 runGenericWorkflowStreaming<TIn, TOut>(endpoint, inputs, callbacks) 通用函数，现有 runWorkflowStreaming 改为封装调用，保持向后兼容。                                                  │
│                                                                                                                                                                                                                   │
│ 改动文件                                                                                                                                                                                                          │
│                                                                                                                                                                                                                   │
│ - frontend/.env                                                                                                                                                                                                   │
│ - frontend/vite.config.ts                                                                                                                                                                                         │
│ - frontend/src/services/dify.ts                                                                                                                                                                                   │
│                                                                                                                                                                                                                   │
│ ---                                                                                                                                                                                                               │
│ Phase 1（P0）：核心模块                                                                                                                                                                                           │
│                                                                                                                                                                                                                   │
│ 1A. 内容生产扩展 — 海报方案 + 视频脚本                                                                                                                                                                            │
│                                                                                                                                                                                                                   │
│ 新增 Dify Workflow：                                                                                                                                                                                              │
│                                                                                                                                                                                                                   │
│ poster-plan-generator.yml（5 节点）：                                                                                                                                                                             │
│ 开始 → LLM(海报方案策划) → Code(JSON提取) → LLM(视觉描述细化) → 输出                                                                                                                                              │
│ - 输入：topic, description, style, num_plans(1/2/3)                                                                                                                                                               │
│ - 输出：result(格式化文本), plans_json(结构化JSON)                                                                                                                                                                │
│                                                                                                                                                                                                                   │
│ video-script-generator.yml（6 节点）：                                                                                                                                                                            │
│ 开始 → LLM(脚本结构) → LLM(详细脚本) → Code(格式校验) → IF/ELSE → 模板/输出                                                                                                                                       │
│ - 输入：topic, description, style, duration(15s/30s/60s), platform(douyin/kuaishou)                                                                                                                               │
│ - 输出：result(分镜表), total_duration, scene_count                                                                                                                                                               │
│                                                                                                                                                                                                                   │
│ 前端改动 — GeneratePage.tsx：                                                                                                                                                                                     │
│ - 顶部新增内容类型切换：「文案」|「海报方案」|「视频脚本」                                                                                                                                                        │
│ - 海报模式：隐藏平台选择，显示方案数量选择，输出为卡片网格                                                                                                                                                        │
│ - 视频模式：显示时长选择器，平台仅限抖音/快手，输出为分镜表格                                                                                                                                                     │
│                                                                                                                                                                                                                   │
│ 新增组件：                                                                                                                                                                                                        │
│ - components/generate/ContentTypeSelector.tsx                                                                                                                                                                     │
│ - components/generate/PosterResult.tsx                                                                                                                                                                            │
│ - components/generate/VideoScriptResult.tsx                                                                                                                                                                       │
│                                                                                                                                                                                                                   │
│ 新增 service 函数：runPosterWorkflow(), runVideoScriptWorkflow()                                                                                                                                                  │
│                                                                                                                                                                                                                   │
│ ---                                                                                                                                                                                                               │
│ 1B. 素材中枢 — 语义搜索 + 真实数据                                                                                                                                                                                │
│                                                                                                                                                                                                                   │
│ 数据迁移：                                                                                                                                                                                                        │
│ - 复制 traffic-project/data/materials/ → frontend/src/data/materials.json（20 条素材元数据）                                                                                                                      │
│ - 上传素材 JSON 到 Dify 知识库 material-metadata                                                                                                                                                                  │
│                                                                                                                                                                                                                   │
│ 新增 Dify Workflow — material-search.yml（5 节点）：                                                                                                                                                              │
│ 开始 → 知识库检索(material-metadata) → LLM(语义排序) → Code(格式化) → 输出                                                                                                                                        │
│ - 输入：query, material_type(all/video/image)                                                                                                                                                                     │
│ - 输出：result, matches_json, match_count                                                                                                                                                                         │
│                                                                                                                                                                                                                   │
│ 前端改动 — MaterialsPage.tsx：                                                                                                                                                                                    │
│ - 替换 mock 数据为真实素材 JSON                                                                                                                                                                                   │
│ - 新增 AI 搜索栏：输入自然语言查询 → 调 Dify workflow → 显示排序结果                                                                                                                                              │
│ - Tab 1「素材库」：真实数据浏览 + 标签筛选 + AI 搜索                                                                                                                                                              │
│ - Tab 2「案例库」/ Tab 3「法规库」：保留现有结构                                                                                                                                                                  │
│                                                                                                                                                                                                                   │
│ 新增组件：                                                                                                                                                                                                        │
│ - components/materials/MaterialCard.tsx                                                                                                                                                                           │
│ - components/materials/MaterialSearchBar.tsx                                                                                                                                                                      │
│ - components/materials/TagFilter.tsx                                                                                                                                                                              │
│                                                                                                                                                                                                                   │
│ ---                                                                                                                                                                                                               │
│ 1C. 内容审核增强 — 三级审核                                                                                                                                                                                       │
│                                                                                                                                                                                                                   │
│ 新增 Dify Workflow — content-reviewer-3level.yml（10 节点）：                                                                                                                                                     │
│ 开始 → LLM(初审:格式+敏感词) → Code(解析)                                                                                                                                                                         │
│      → LLM(复审:内容质量) → Code(解析)                                                                                                                                                                            │
│      → LLM(终审:政策合规) → Code(解析)                                                                                                                                                                            │
│      → Code(综合判定) → Template(审核报告) → 输出                                                                                                                                                                 │
│ - 输入：content, platform(可选), content_source(可选)                                                                                                                                                             │
│ - 输出：result(完整报告), final_status(approved/revision_required/rejected), review_json, issue_count                                                                                                             │
│                                                                                                                                                                                                                   │
│ Prompt 来源：直接复用 traffic-project/templates/review-checklist.md 中的审核标准。                                                                                                                                │
│                                                                                                                                                                                                                   │
│ 前端改动 — ContentManagementPage.tsx：                                                                                                                                                                            │
│ - 内容项增加「提交审核」按钮                                                                                                                                                                                      │
│ - 点击后弹出 ReviewDialog，显示内容 + 三阶段审核进度                                                                                                                                                              │
│ - 审核结果展示三级报告（初审/复审/终审），可折叠                                                                                                                                                                  │
│ - 审核记录存 localStorage                                                                                                                                                                                         │
│                                                                                                                                                                                                                   │
│ 新增组件：                                                                                                                                                                                                        │
│ - components/review/ReviewDialog.tsx                                                                                                                                                                              │
│ - components/review/ReviewProgress.tsx（三阶段进度条）                                                                                                                                                            │
│ - components/review/ReviewReport.tsx                                                                                                                                                                              │
│                                                                                                                                                                                                                   │
│ ---                                                                                                                                                                                                               │
│ Phase 2（P1）：扩展模块                                                                                                                                                                                           │
│                                                                                                                                                                                                                   │
│ 2A. 宣传计划 — 新增 PlanPage                                                                                                                                                                                      │
│                                                                                                                                                                                                                   │
│ 现有 content-strategy-planner.yml workflow 已可用，只缺前端。                                                                                                                                                     │
│                                                                                                                                                                                                                   │
│ 新增页面 — pages/PlanPage.tsx：                                                                                                                                                                                   │
│ - 左栏：目标输入、受众、平台多选、时间范围（周/月/季度）、背景信息                                                                                                                                                │
│ - 右栏：SSE 流式进度 → 两个 tab（策略方案 / 发布排期）                                                                                                                                                            │
│ - 操作按钮：复制、下载 Markdown                                                                                                                                                                                   │
│                                                                                                                                                                                                                   │
│ 路由和导航：                                                                                                                                                                                                      │
│ - routes.tsx 增加 { path: "plan", element: <PlanPage /> }                                                                                                                                                         │
│ - DashboardLayout.tsx 菜单增加 { path: "/plan", icon: Calendar, label: "宣传计划" }                                                                                                                               │
│                                                                                                                                                                                                                   │
│ ---                                                                                                                                                                                                               │
│ 2B. 效果分析 — 新增 Analytics Workflow + Page                                                                                                                                                                     │
│                                                                                                                                                                                                                   │
│ 数据迁移：                                                                                                                                                                                                        │
│ - 复制 traffic-project/data/analytics/*.json（3 个平台数据）                                                                                                                                                      │
│ - 复制 traffic-project/data/accident-data/2025-summary.json                                                                                                                                                       │
│                                                                                                                                                                                                                   │
│ 新增 Dify Workflow — analytics-reporter.yml（4 节点）：                                                                                                                                                           │
│ 开始 → Code(解析数据+聚合指标) → LLM(生成分析报告) → 输出                                                                                                                                                         │
│ - 输入：wechat_data, weibo_data, douyin_data（JSON字符串）, analysis_month, focus_area                                                                                                                            │
│ - 输出：result(Markdown报告), summary_json                                                                                                                                                                        │
│                                                                                                                                                                                                                   │
│ 注：Dify 无法读本地文件，前端读取静态 JSON 后作为字符串传入。                                                                                                                                                     │
│                                                                                                                                                                                                                   │
│ 新增页面 — pages/AnalyticsPage.tsx：                                                                                                                                                                              │
│ - 上部：三平台核心指标卡片（从静态 JSON 读取）                                                                                                                                                                    │
│ - 下部：AI 分析报告生成区（选月份 → 调 Dify → 显示报告）                                                                                                                                                          │
│                                                                                                                                                                                                                   │
│ HomePage 更新：用真实 analytics JSON 数据替换 mock 统计数字。                                                                                                                                                     │
│                                                                                                                                                                                                                   │
│ 路由和导航：                                                                                                                                                                                                      │
│ - routes.tsx 增加 { path: "analytics", element: <AnalyticsPage /> }                                                                                                                                               │
│ - DashboardLayout.tsx 菜单增加 { path: "/analytics", icon: BarChart3, label: "效果分析" }                                                                                                                         │
│                                                                                                                                                                                                                   │
│ ---                                                                                                                                                                                                               │
│ Phase 3（P2）：未来规划（仅设计）                                                                                                                                                                                 │
│ ┌──────────┬─────────────────────────────────────────────────┬──────────────────┐                                                                                                                                 │
│ │   模块   │                    Dify 方案                    │       备注       │                                                                                                                                 │
│ ├──────────┼─────────────────────────────────────────────────┼──────────────────┤                                                                                                                                 │
│ │ 精准宣传 │ workflow 读取事故数据 → LLM 风险分析 → 定向方案 │ 需 accident-data │                                                                                                                                 │
│ ├──────────┼─────────────────────────────────────────────────┼──────────────────┤                                                                                                                                 │
│ │ 应急响应 │ copywriter 简化版 + 预设"紧急"模板              │ 快速生成         │                                                                                                                                 │
│ ├──────────┼─────────────────────────────────────────────────┼──────────────────┤                                                                                                                                 │
│ │ 公共关系 │ Dify Chatflow（对话模式，非 workflow）          │ Chat UI 组件     │                                                                                                                                 │
│ └──────────┴─────────────────────────────────────────────────┴──────────────────┘                                                                                                                                 │
│ ---                                                                                                                                                                                                               │
│ 数据迁移清单                                                                                                                                                                                                      │
│ ┌──────────────────────────────────────┬─────────────────────────────────────────────────────┬────────────────┐                                                                                                   │
│ │       来源 (traffic-project/)        │               目标 (openclaw-deploy/)               │      用途      │                                                                                                   │
│ ├──────────────────────────────────────┼─────────────────────────────────────────────────────┼────────────────┤                                                                                                   │
│ │ data/materials/index.json + items/*  │ frontend/src/data/materials.json + 上传 Dify 知识库 │ 素材库         │                                                                                                   │
│ ├──────────────────────────────────────┼─────────────────────────────────────────────────────┼────────────────┤                                                                                                   │
│ │ data/analytics/*.json (3文件)        │ frontend/src/data/analytics/                        │ 效果分析       │                                                                                                   │
│ ├──────────────────────────────────────┼─────────────────────────────────────────────────────┼────────────────┤                                                                                                   │
│ │ data/accident-data/2025-summary.json │ frontend/src/data/accident-data/                    │ 效果分析上下文 │                                                                                                   │
│ ├──────────────────────────────────────┼─────────────────────────────────────────────────────┼────────────────┤                                                                                                   │
│ │ templates/review-checklist.md        │ 嵌入 reviewer workflow prompt                       │ 审核标准       │                                                                                                   │
│ ├──────────────────────────────────────┼─────────────────────────────────────────────────────┼────────────────┤                                                                                                   │
│ │ templates/report-monthly.md          │ 嵌入 analytics workflow prompt                      │ 报告模板       │                                                                                                   │
│ └──────────────────────────────────────┴─────────────────────────────────────────────────────┴────────────────┘                                                                                                   │
│ ---                                                                                                                                                                                                               │
│ Dify 手动操作清单                                                                                                                                                                                                 │
│                                                                                                                                                                                                                   │
│ 以下需在 Dify Web UI (http://10.8.30.110) 手动完成：                                                                                                                                                              │
│                                                                                                                                                                                                                   │
│ 1. 导入 4 个新 Workflow YAML → 获取 4 个新 API Key                                                                                                                                                                │
│ 2. 为已有 planner workflow 获取 API Key（如未单独创建 App）                                                                                                                                                       │
│ 3. 创建知识库 material-metadata，上传 20 个素材 JSON                                                                                                                                                              │
│ 4. （可选）创建知识库 traffic-regulations，补全 regulation-lookup workflow                                                                                                                                        │
│                                                                                                                                                                                                                   │
│ ---                                                                                                                                                                                                               │
│ 全部改动文件清单                                                                                                                                                                                                  │
│                                                                                                                                                                                                                   │
│ 新增 Dify Workflow（4 个）                                                                                                                                                                                        │
│                                                                                                                                                                                                                   │
│ - dify-workflows/poster-plan-generator.yml                                                                                                                                                                        │
│ - dify-workflows/video-script-generator.yml                                                                                                                                                                       │
│ - dify-workflows/content-reviewer-3level.yml                                                                                                                                                                      │
│ - dify-workflows/analytics-reporter.yml                                                                                                                                                                           │
│                                                                                                                                                                                                                   │
│ 修改前端文件（7 个）                                                                                                                                                                                              │
│                                                                                                                                                                                                                   │
│ - frontend/.env — 新增 6 个 API Key                                                                                                                                                                               │
│ - frontend/vite.config.ts — 新增 6 条代理路由                                                                                                                                                                     │
│ - frontend/src/services/dify.ts — 泛化 + 新增 workflow 调用函数                                                                                                                                                   │
│ - frontend/src/pages/GeneratePage.tsx — 内容类型切换 + 海报/视频模式                                                                                                                                              │
│ - frontend/src/pages/MaterialsPage.tsx — 真实数据 + AI 搜索                                                                                                                                                       │
│ - frontend/src/pages/ContentManagementPage.tsx — 三级审核功能                                                                                                                                                     │
│ - frontend/src/pages/HomePage.tsx — 真实统计数据                                                                                                                                                                  │
│ - frontend/src/components/DashboardLayout.tsx — 新增 2 个菜单项                                                                                                                                                   │
│ - frontend/src/routes.tsx — 新增 2 条路由                                                                                                                                                                         │
│                                                                                                                                                                                                                   │
│ 新增前端页面（2 个）                                                                                                                                                                                              │
│                                                                                                                                                                                                                   │
│ - frontend/src/pages/PlanPage.tsx                                                                                                                                                                                 │
│ - frontend/src/pages/AnalyticsPage.tsx                                                                                                                                                                            │
│                                                                                                                                                                                                                   │
│ 新增前端组件（~10 个）                                                                                                                                                                                            │
│                                                                                                                                                                                                                   │
│ - components/generate/ContentTypeSelector.tsx                                                                                                                                                                     │
│ - components/generate/PosterResult.tsx                                                                                                                                                                            │
│ - components/generate/VideoScriptResult.tsx                                                                                                                                                                       │
│ - components/materials/MaterialCard.tsx                                                                                                                                                                           │
│ - components/materials/MaterialSearchBar.tsx                                                                                                                                                                      │
│ - components/materials/TagFilter.tsx                                                                                                                                                                              │
│ - components/review/ReviewDialog.tsx                                                                                                                                                                              │
│ - components/review/ReviewProgress.tsx                                                                                                                                                                            │
│ - components/review/ReviewReport.tsx                                                                                                                                                                              │
│                                                                                                                                                                                                                   │
│ 新增数据文件（5 个，从 traffic-project 复制）                                                                                                                                                                     │
│                                                                                                                                                                                                                   │
│ - frontend/src/data/materials.json                                                                                                                                                                                │
│ - frontend/src/data/analytics/wechat-202601.json                                                                                                                                                                  │
│ - frontend/src/data/analytics/weibo-202601.json                                                                                                                                                                   │
│ - frontend/src/data/analytics/douyin-202601.json                                                                                                                                                                  │
│ - frontend/src/data/accident-data/2025-summary.json                                                                                                                                                               │
│                                                                                                                                                                                                                   │
│ ---                                                                                                                                                                                                               │
│ 实施顺序                                                                                                                                                                                                          │
│                                                                                                                                                                                                                   │
│ 1. Phase 0 — 多 Workflow 代理 + 泛化 service 层                                                                                                                                                                   │
│ 2. Phase 1C — 三级审核（复用已有 sensitive-word-checker 模式）                                                                                                                                                    │
│ 3. Phase 1B — 素材库（数据迁移 + 知识库 + 搜索）                                                                                                                                                                  │
│ 4. Phase 1A — 海报 + 视频脚本（GeneratePage 最大改动）                                                                                                                                                            │
│ 5. Phase 2A — 宣传计划页面（最快，workflow 已有）                                                                                                                                                                 │
│ 6. Phase 2B — 效果分析（workflow + 新页面 + HomePage 更新）                                                                                                                                                       │
│                                                                                                                                                                                                                   │
│ 验证方式                                                                                                                                                                                                          │
│                                                                                                                                                                                                                   │
│ 每个 Phase 完成后：                                                                                                                                                                                               │
│ - npx tsc -b --noEmit 确保无类型错误                                                                                                                                                                              │
│ - npm run dev 启动，手动验证对应页面功能                                                                                                                                                                          │
│ - 确认 SSE 流式进度正常显示                                                                                                                                                                                       │
│ - 确认 Dify workflow 输出正确渲染          